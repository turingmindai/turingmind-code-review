#!/bin/bash

# TuringMind Code Review - Pre-Push Hook
# Version: 1.1.0
# Runs /turingmind-code-review:review on changes before pushing to remote
# Blocks push if Critical or High severity issues are found

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo ""
echo -e "${CYAN}üß† Running TuringMind Code Review before push...${NC}"
echo ""

# Get the remote and URL being pushed to
remote="$1"
url="$2"

# Read stdin to get refs being pushed
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # Branch is being deleted, skip
        continue
    fi

    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch, compare against default branch
        base_ref=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "main")
        range="origin/$base_ref...$local_sha"
    else
        # Existing branch, compare against remote
        range="$remote_sha...$local_sha"
    fi

    # Get all changed files
    changed_files=$(git diff --name-only "$range" 2>/dev/null || true)

    if [ -z "$changed_files" ]; then
        echo -e "${GREEN}‚úÖ No files to review${NC}"
        exit 0
    fi

    file_count=$(echo "$changed_files" | wc -l | tr -d ' ')
    echo "üìÅ Reviewing $file_count file(s)..."
    echo ""

    # Check if Claude CLI is available
    if ! command -v claude &> /dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  Claude CLI not found. Skipping code review.${NC}"
        echo "   Install: npm install -g @anthropic-ai/claude-code"
        exit 0
    fi

    # Run code review with --print flag for non-interactive output
    review_output=$(mktemp)

    if claude --print "/turingmind-code-review:review" > "$review_output" 2>&1; then
        # Check for Critical severity issues (95-100)
        if grep -qE 'üî¥|Critical \(95-100\)|CRITICAL' "$review_output"; then
            echo -e "${RED}‚ùå PUSH BLOCKED - Critical issues found${NC}"
            echo ""
            cat "$review_output"
            echo ""
            echo -e "${RED}Fix critical issues before pushing.${NC}"
            rm "$review_output"
            exit 1
        # Check for Warning severity issues (80-94)
        elif grep -qE 'üü†|Warning \(80-94\)|HIGH' "$review_output"; then
            echo -e "${YELLOW}‚ö†Ô∏è  Warning issues found (non-blocking)${NC}"
            echo ""
            cat "$review_output"
            echo ""
            echo -e "${YELLOW}Consider fixing these issues.${NC}"
            # Warnings are non-blocking by default
            # To make warnings block, uncomment the next two lines:
            # rm "$review_output"
            # exit 1
        else
            echo -e "${GREEN}‚úÖ Code review passed${NC}"
            echo ""
            cat "$review_output"
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Code review failed to run. Allowing push.${NC}"
        echo "   Check Claude CLI configuration."
    fi

    rm -f "$review_output"
done

echo ""
exit 0

